---
# System-specific OpenSSH setup
# =============================
# Tim Friske <me@tifr.de>

- name: Get OpenSSH version
  command: ssh -V
  register: openssh_version_raw
  changed_when: false
  check_mode: false

- name: Parse OpenSSH version
  set_fact:
    openssh_version: >-
      {{
        openssh_version_raw.stderr
        | regex_replace('.*_([0-9]*.[0-9]).*', '\\1')
      }}

- name: Detect state of sysconfig file
  stat:
    path: "{{ openssh_sysconfig_file }}"
  register: openssh_sysconfig_file_stat

- name: Detect state of OpenSSH client drop-in configuration directory
  stat:
    path: "{{ openssh_config_dir_client }}"
  register: openssh_config_dir_client_stat

- name: Detect state of OpenSSH daemon drop-in configuration directory
  stat:
    path: "{{ openssh_config_dir_daemon }}"
  register: openssh_config_dir_daemon_stat

- name: Manage moduli file
  import_tasks: moduli.yml

- name: Disable auto generation of OpenSSH host keys
  lineinfile:
    regexp: '^SSHD_AUTO_KEYGEN="yes"$'
    line: SSHD_AUTO_KEYGEN="no"
    path: "{{ openssh_sysconfig_file }}"
    state: present
  when: openssh_sysconfig_file_stat.stat.exists

- name: Manage OpenSSH host keys
  include_tasks: key.yml
  loop: "{{ openssh_host_key_algorithms }}"
