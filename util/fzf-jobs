#!/usr/bin/env bash
#
# Manage jobs with fuzzy finder
# =============================
# Tim Friske <me@tifr.de>
#
# List, background and foreground jobs.
#
# See also:
#   * man:bash[1]
#   * man:fzf[1]
#   * fzf-cmd

shopt -os nounset pipefail errexit errtrace
shopt -s extglob globstar

function print_usage {
  {
    printf 'usage: '
    printf 'function %s { eval "$(jobs | fzf-%s "$@")"; } ' "$1" "$2"
    printf '\n'
  } 1>&2
}

function print_job_cmd_line {
  [[ "$#" -eq 0 ]] && return
  printf '%s -- ' "${0##*/fzf-}"
  printf '%s ' "$@"
  printf '\n'
}

function fzf_jobs {
  if [[ -t 0 ]]; then
    print_usage 'jj' 'jobs'
    print_usage 'jb' 'bg'
    print_usage 'jf' 'fg'
    exit
  elif [[ "$#" -gt 0 ]]; then
    print_job_cmd_line "$@"
    exit
  fi

  local options=''
  options+="${FZF_DEFAULT_OPTS:-} ${FZF_JOBS_FZF_OPTS:-} "
  options+="--print0 "

  local job='' jobspecs=()
  while read -r -d '' job; do
    if [[ "$job" =~ ^\[([[:digit:]]+)\] ]]; then
      jobspecs+=("%${BASH_REMATCH[1]}")
    fi
  done < <(FZF_DEFAULT_OPTS="$options" "$(fzf-cmd)")

  print_job_cmd_line "${jobspecs[@]}"
}

fzf_jobs "$@"
