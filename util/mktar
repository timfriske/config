#!/usr/bin/env bash

# TAR Tape Archive creation
# =========================
# Tim Friske <me@tifr.de>
#
# Simple tape archive (TAR) creation utility which archives and
# optionally compresses a given folder by creating an archive file with
# the folder contents, folder name as base name and the appropriate file
# extension.
#
# Depending under which name this program is invoked it either creates
# an uncompressed TAR archive or one with different compression
# algorithms.  To achieve that this program must be installed as `mktar`
# together with the symbolic links `mktbz`, `mktgz`, `mktxz`, `mktzst`
# pointing at it.  Thereby each of the symbolic links represents the
# different compression algorithms with which to compress the resulting
# TAR file.
#
# See also:
#   * man:bash[1]
#   * man:tar[1]
#   * man:bzip2[1]
#   * man:gzip[1]
#   * man:xz[1]
#   * man:zstd[1]

shopt -os nounset pipefail errexit errtrace

declare -r prog_name="${0##*/}"

function errmsg {
  echo >&2 "$@"
}

function get_path {
  realpath --no-symlinks "$1"
}

function get_path_rel {
  realpath --no-symlinks --relative-base='.' "$1"
}

function mktar {
  if [[ "$#" -eq 0 ]]; then
    errmsg 'usage: mktar <file>|<folder>'
    errmsg 'usage: mktbz <file>|<folder>'
    errmsg 'usage: mktgz <file>|<folder>'
    errmsg 'usage: mktxz <file>|<folder>'
    errmsg 'usage: mktzst <file>|<folder>'
    exit 1
  fi
  local fs_path="$(get_path "${1:-}")"
  local fs_path_rel="$(get_path_rel "${1:-}")"
  if [[ ! -e "$fs_path" ]]; then
    errmsg 'First argument must be path to existing file or folder!'
    exit 1
  fi
  if [[ "$fs_path" == '/' ]]; then
    errmsg 'Cannot archive root folder. Use GNU Tar for that!'
  fi
  local archive="$fs_path"
  echo '# Archiving files ...'
  echo '# ==================='
  case "$prog_name" in
    mktar)
      archive+=".tar"
      tar --create --file="$archive" --verbose -- "$fs_path_rel"
      ;;
    mktbz)
      archive+=".tar.bz2"
      tar --create --bzip2 --file="$archive" --verbose -- "$fs_path_rel"
      ;;
    mktgz)
      archive+=".tar.gz"
      tar --create --gzip --file="$archive" --verbose -- "$fs_path_rel"
      ;;
    mktxz)
      archive+=".tar.xz"
      tar --create --xz --file="$archive" --verbose -- "$fs_path_rel"
      ;;
    mktzst)
      archive+=".tar.zst"
      tar --create --zstd --file="$archive" --verbose -- "$fs_path_rel"
      ;;
    *)
      errmsg 'Must be one of mktar, mktbz, mktgz, mktxz, mktzst!'
      exit 2
      ;;
  esac
  local message="... files archived in $archive"
  local msg_sep="$(eval printf '=%.0s' {1..${#message}})"
  echo "# $msg_sep"
  echo "# $message"
}

mktar "$@"
