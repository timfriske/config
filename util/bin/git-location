#!/usr/bin/env bash
#
# Git Location
# ============
# Tim Friske <tifr@me.de>
#
# Display the location, i.e. the _Git_ branch, tag or commit at which
# the symbolic ref `HEAD` points.

shopt -os nounset pipefail errexit errtrace

function get_branch {
  git symbolic-ref --quiet --short "${ref:-HEAD}"
}

function get_tag {
  git describe --tags --exact-match "${ref:-HEAD}" 2> /dev/null
}

function get_commit {
  git rev-parse --short "${ref:-HEAD}"
}

# Tries to display the current branch, tag or commit in this order.
#
function git_location {
  local fmt="${fmt:-|type|:|object|\n}"
  local tbr="${tbr:-branch}"
  local tta="${tta:-tag}"
  local tco="${tco:-commit}"

  local branch="$(get_branch)"
  if [[ -n "$branch" ]]; then
    fmt="${fmt/|type|/$tbr}"
    fmt="${fmt/|object|/$branch}"
    printf -- "${fmt}"
    exit 0
  fi

  local tag="$(get_tag)"
  if [[ -n "$tag" ]]; then
    fmt="${fmt/|type|/$tta}"
    fmt="${fmt/|object|/$tag}"
    printf -- "$fmt"
    exit 0
  fi

  local commit="$(get_commit)"
  if [[ -n "$commit" ]]; then
    fmt="${fmt/|type|/$tco}"
    fmt="${fmt/|object|/$commit}"
    printf -- "$fmt"
    exit 0
  fi

  exit 1
}

git_location "$@"
