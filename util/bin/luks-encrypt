#!/usr/bin/env sh

ensure_block_special_file() {
    local file="${1:-${file:?'required'}}"
    if [ ! -b "${file}" ]; then
        echo >&2 Given file must be a block special device! Aborting...
        exit 1
    fi
}

# Creates a LUKS encrypted container with on-disk format version 2.
modern_crypt() {
    local device="${1:-${device:?'required'}}"
    ensure_block_special_file "${device}"
    local label="${2:-${label:-}}"
    cryptsetup \
      --verbose \
      --verify-passphrase \
      --cipher aes-xts-plain64 \
      --key-size 512 \
      --hash sha512 \
      --pbkdf pbkdf2 \
      --type luks2 \
      ${label:+--label "${label}"} \
      luksFormat \
      "${device}"
}

# Creates a LUKS encrypted container with on-disk format version 1.
compat_crypt() {
  local device="${1:-${device:?'required'}}"
  ensure_block_special_file "${device}"
  cryptsetup \
    --verbose \
    --verify-passphrase \
    --cipher aes-xts-plain64 \
    --key-size 512 \
    --hash sha512 \
    --type luks1 \
    luksFormat \
    "${device}"
}

main() {
  local style="${1:-${style:?'required'}}"
  local device="${2:-${device:?'required'}}"
  local label="${3:-${label:-}}"
  shift $(($#-($#${1+-1}${2+-1}${3+-1})))
  case "${style}" in
  modern) modern_crypt "${device}" "${label}" ;;
  compat) compat_crypt "${device}" ;;
  *)
    echo >&2 Style must be one of modern, compat! Aborting...
    exit 1
    ;;
  esac
}

main "${@}"
