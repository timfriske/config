#!/usr/bin/env bash
#
# Change directories with fuzzy finder
# ====================================
# Tim Friske <me@tifr.de>
#
# See also:
#   * man:bash[1]
#   * man:find[1]
#   * man:fzf[1]
#   * man:sort[1]

shopt -os nounset pipefail errexit errtrace

function print_help {
  1>&2 cat \
<<'HELP'
Help
====
`Fzf-cd` offers the user to quickly select the directory from all the
directories below the current directory to change into.  By default only
visible and numerically sorted directories are presented.  For ease of
use the `Fzf-cd` command should be bound to hot keys, such as `Alt-c`.

Usage
-----
.Command line syntax
----
fzf-cd [--help]
----

Options
-------
--help::
  Print this program's help text.

HELP
}

function find_dirs {
  ${FZF_CD_FIND_DIRS_CMD:-find_dirs_default} 2> /dev/null
}

function find_dirs_default {
  find -L -mindepth 1 \
    \( \
      -path '*/\.*' \
      -o -fstype sysfs \
      -o -fstype devfs \
      -o -fstype devtmpfs \
      -o -fstype proc \
    \) \
    -prune \
    -o -type d \
    -print0
}

function sort_dirs {
  ${FZF_CD_SORT_DIRS_CMD:-sort_dirs_default}
}

function sort_dirs_default {
  sort --sort=numeric --zero-terminated
}

function select_dir {
  local fzf_options=()
  fzf_options+=('--read0')
  fzf_options+=(${FZF_DEFAULT_OPTS:-})
  fzf_options+=(${FZF_CD_FZF_OPTS:-})
  fzf_options+=('--no-multi')
  fzf "${fzf_options[@]}"
}

function fzf_cd {
  if [[ "${1:-}" == '--help' ]]; then
    print_help
    exit
  fi
  local dir="$(find_dirs | sort_dirs | select_dir)"
  if [[ -n "$dir" ]]; then
    printf 'cd -- %q' "$dir"
  fi
}

fzf_cd "$@"
